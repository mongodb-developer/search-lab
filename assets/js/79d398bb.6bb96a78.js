"use strict";(self.webpackChunksearch_party_lab=self.webpackChunksearch_party_lab||[]).push([[1299],{2183:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>p,frontMatter:()=>l,metadata:()=>c,toc:()=>u});var r=t(4848),o=t(8453),a=t(1470),i=t(9365);const l={},s="Using Google Cloud Vertex AI",c={id:"vector-search/create-vectors/google-vertex",title:"Using Google Cloud Vertex AI",description:"Take-home activity! Do it if you are following along at home. It won't be covered during the hands-on lab.",source:"@site/docs/7-vector-search/5-create-vectors/2-google-vertex.mdx",sourceDirName:"7-vector-search/5-create-vectors",slug:"/vector-search/create-vectors/google-vertex",permalink:"/search-lab/docs/vector-search/create-vectors/google-vertex",draft:!1,unlisted:!1,editUrl:"https://github.com/mongodb-developer/search-lab/blob/main/docs/7-vector-search/5-create-vectors/2-google-vertex.mdx",tags:[],version:"current",sidebarPosition:2,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Using OpenAI",permalink:"/search-lab/docs/vector-search/create-vectors/openai"},next:{title:"Using Amazon SageMaker",permalink:"/search-lab/docs/vector-search/create-vectors/ws-sagemaker"}},d={},u=[{value:"Create a Google Cloud account",id:"create-a-google-cloud-account",level:2},{value:"Create a new project",id:"create-a-new-project",level:2},{value:"Open Cloud Shell",id:"open-cloud-shell",level:2},{value:"Enable the AI Platform API",id:"enable-the-ai-platform-api",level:2},{value:"Create an authentication file",id:"create-an-authentication-file",level:2},{value:"Create embeddings for some text",id:"create-embeddings-for-some-text",level:2},{value:"Create embeddings for the books",id:"create-embeddings-for-the-books",level:2},{value:"Querying with vectors",id:"querying-with-vectors",level:2},{value:"Configuring the application",id:"configuring-the-application",level:2},{value:"Configuring the application",id:"configuring-the-application-1",level:2},{value:"Running the application",id:"running-the-application",level:2}];function h(e){const n={a:"a",admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components},{Screenshot:t}=n;return t||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Screenshot",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"using-google-cloud-vertex-ai",children:"Using Google Cloud Vertex AI"})}),"\n",(0,r.jsx)(n.admonition,{type:"info",children:(0,r.jsx)(n.p,{children:"Take-home activity! Do it if you are following along at home. It won't be covered during the hands-on lab."})}),"\n",(0,r.jsx)(n.p,{children:"Google Cloud now offers a series of AI platform services that are built on top of Vertex AI. These services are designed to help you build, deploy, and manage machine learning models."}),"\n",(0,r.jsxs)(n.p,{children:["To create embeddings, they offer several services to convert text, images, or both into embeddings. In our application, we will use the ",(0,r.jsx)(n.code,{children:"multimodal"})," embedding model to search for books by a description of the cover image."]}),"\n",(0,r.jsx)(n.h2,{id:"create-a-google-cloud-account",children:"Create a Google Cloud account"}),"\n",(0,r.jsx)(n.p,{children:"The first step is to create a Google Cloud account. Use the following link to get started with free credits."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://cloud.google.com/free",children:"Sign Up for a Google Cloud Account"})}),"\n",(0,r.jsx)(n.h2,{id:"create-a-new-project",children:"Create a new project"}),"\n",(0,r.jsx)(n.p,{children:"For the welcome screen, create a new project. You can name it whatever you like."}),"\n",(0,r.jsx)(n.p,{children:"Make sure that you pick an active billing account."}),"\n",(0,r.jsx)(t,{src:"/img/screenshots/7-vector-search/5-create-vectors/4-google-vertex/1-create-project.png",url:"https://cloud.google.com"}),"\n",(0,r.jsxs)(n.p,{children:["Once the fields are filled out, click the ",(0,r.jsx)(n.strong,{children:"Create"})," button."]}),"\n",(0,r.jsx)(n.h2,{id:"open-cloud-shell",children:"Open Cloud Shell"}),"\n",(0,r.jsxs)(n.p,{children:["Once your project is created, look for the ",(0,r.jsx)(n.strong,{children:"Activate Cloud Shell"})," button in the top right corner of the screen."]}),"\n",(0,r.jsx)(t,{src:"/img/screenshots/7-vector-search/5-create-vectors/4-google-vertex/2-activate-cloud-shell.png",url:"https://cloud.google.com"}),"\n",(0,r.jsx)(n.p,{children:"This will open up a terminal-like window in your browser. This is a fully functional terminal that is connected to a virtual machine in the cloud. You can use this terminal to run commands on your virtual machine."}),"\n",(0,r.jsx)(n.h2,{id:"enable-the-ai-platform-api",children:"Enable the AI Platform API"}),"\n",(0,r.jsx)(n.p,{children:"You will need to enable the AI Platform API for your project. You can do this by running the following command in your Cloud Shell."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"gcloud services enable aiplatform.googleapis.com\n"})}),"\n",(0,r.jsx)(n.h2,{id:"create-an-authentication-file",children:"Create an authentication file"}),"\n",(0,r.jsx)(n.p,{children:"To authenticate with the AI Platform API, you will need to create a file that contains your application credentials. You can do this by running the following command in your Cloud Shell."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"gcloud auth application-default login\n"})}),"\n",(0,r.jsx)(n.p,{children:"Follow the instructions in the terminal to authenticate with your Google Cloud account. Once you have authenticated, you will see a message similar to the following."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"Credentials saved to file: [/tmp/tmp.n0HdRFDDv8/application_default_credentials.json]\n"})}),"\n",(0,r.jsx)(n.p,{children:"Save the credentials file to your home directory."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"mv /tmp/tmp.n0HdRFDDv8/application_default_credentials.json ~/credentials.json\n"})}),"\n",(0,r.jsx)(n.h2,{id:"create-embeddings-for-some-text",children:"Create embeddings for some text"}),"\n",(0,r.jsxs)(n.p,{children:["Start by creating a ",(0,r.jsx)(n.code,{children:"request.json"})," file. This file will contain the text that you want to convert into embeddings. Run the following command in the Cloud Shell to create this file."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'echo \'{\n  "instances": [\n    {\n      "text": "picture of a cat"\n    }\n  ]\n}\' >> request.json\n'})}),"\n",(0,r.jsx)(n.p,{children:"Now run the following curl command to get the embeddings for the text."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'curl -X POST \\\n    -H "Authorization: Bearer $(gcloud auth print-access-token)" \\\n    -H "Content-Type: application/json; charset=utf-8" \\\n    -d @request.json \\\n    "https://us-central1-aiplatform.googleapis.com/v1/projects/$PROJECT_ID/locations/us-central1/publishers/google/models/multimodalembedding@001:predict"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Make sure to change the ",(0,r.jsx)(n.code,{children:"$PROJECT_ID"})," variable to your project ID."]}),"\n",(0,r.jsx)(n.p,{children:"You will receive a response similar to:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "predictions": [\n    {\n      "textEmbedding": [\n        -0.00566103263,\n        0.0202014241,\n        -0.00677233562,\n        0.0180264488,\n        0.0265100803,\n         ...\n        0.00116232142,\n        0.0134601779,\n        -0.00257002981\n      ]\n    }\n  ],\n  "deployedModelId": "5595742328217141248"\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["You will notice that the ",(0,r.jsx)(n.code,{children:"textEmbeddings"})," fields contain an array of 1408 numbers. These are the embeddings for the text that you provided."]}),"\n",(0,r.jsx)(n.h2,{id:"create-embeddings-for-the-books",children:"Create embeddings for the books"}),"\n",(0,r.jsx)(n.p,{children:"To create the embeddings for the books in your collection, run this curl command for each book. This process is somewhat time-consuming, so we've already created them for you."}),"\n",(0,r.jsxs)(n.p,{children:["You can find the 1408 dimensions vector in the ",(0,r.jsx)(n.code,{children:"embeddings"})," field of the new books collection you imported."]}),"\n",(0,r.jsx)(n.p,{children:"Because we already have the vectors for the books, we can use them with Vector Search."}),"\n",(0,r.jsx)(n.h2,{id:"querying-with-vectors",children:"Querying with vectors"}),"\n",(0,r.jsx)(n.p,{children:"To query the data, Vector Search will need to calculate the distance between the query vector and the vectors of the documents in the collection."}),"\n",(0,r.jsx)(n.p,{children:"To do so, you will need to vectorize your query. You can use the same function to vectorize your query, as well."}),"\n",(0,r.jsxs)(a.A,{groupId:"server",children:[(0,r.jsxs)(i.A,{value:"node",label:"\ud83d\ude80 NodeJS/Express",children:[(0,r.jsxs)(n.p,{children:["In the library application, we've created a function that will vectorize your query for you. You can find it in the ",(0,r.jsx)(n.code,{children:"server/embeddings/googleVertex.mjs"})," file."]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"import aiplatform from '@google-cloud/aiplatform';\n\nconst project = process.env.PROJECT_ID;\nconst location = process.env.PROJECT_LOCATION;\n\nconst {PredictionServiceClient} = aiplatform.v1;\nconst {helpers} = aiplatform;\nconst predictionServiceClient = new PredictionServiceClient({\n    apiEndpoint: 'us-central1-aiplatform.googleapis.com'\n});\n\nconst getTermEmbeddings = async (text) => {\n  const publisher = \"google\";\n  const model = 'multimodalembedding@001';\n\n  // Configure the parent resource\n  const endpoint = `projects/${project}/locations/${location}/publishers/${publisher}/models/${model}`;\n\n  const instance = { text };\n  const instanceValue = helpers.toValue(instance);\n  const instances = [instanceValue];\n\n  const request = {\n    endpoint,\n    instances\n  };\n\n  // Predict request\n  const [response] = await predictionServiceClient.predict(request);\n  const embeddings = response.predictions[0].structValue.fields.textEmbedding.listValue.values.map(e => e.numberValue);\n\n  return embeddings;\n};\n\nexport default getTermEmbeddings;\n"})}),(0,r.jsx)(n.h2,{id:"configuring-the-application",children:"Configuring the application"}),(0,r.jsxs)(n.p,{children:["In your ",(0,r.jsx)(n.code,{children:"server/.env"})," file, you'll find a few variables that you can use to configure the application."]}),(0,r.jsxs)(n.p,{children:["The first one is ",(0,r.jsx)(n.code,{children:"EMBEDDINGS_SOURCE"}),". It tells the application where to get the embeddings from. You can set it to ",(0,r.jsx)(n.code,{children:"googleVertex"}),"."]}),(0,r.jsxs)(n.p,{children:["Then, set the ",(0,r.jsx)(n.code,{children:"EMBEDDING_KEY"})," to your ",(0,r.jsx)(n.code,{children:"credentials.json"})," file."]}),(0,r.jsxs)(n.p,{children:["Finally, set the ",(0,r.jsx)(n.code,{children:"PROJECT_ID"})," and ",(0,r.jsx)(n.code,{children:"PROJECT_LOCATION"})," to the values for your project."]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'EMBEDDINGS_SOURCE=googleVertex\nEMBEDDING_KEY="./credentials.json"\nPROJECT_ID=projectphoenix-verteximage\nPROJECT_LOCATION=us-central1\n'})}),(0,r.jsxs)(n.p,{children:["Your application now has a ",(0,r.jsx)(n.code,{children:"getTermEmbeddings"})," function that will return the embeddings for a given text. You can see the details of this file in the ",(0,r.jsx)(n.code,{children:"server/src/embeddings/googleVertex.js"})," file."]})]}),(0,r.jsxs)(i.A,{value:"java",label:"\u2615\ufe0f Java Spring Boot",children:[(0,r.jsxs)(n.p,{children:["To run semantic queries in Java, the application also needs to generate embeddings for your query.",(0,r.jsx)(n.br,{}),"\n","This is handled by the ",(0,r.jsx)(n.a,{href:"https://github.com/mongodb-developer/library-management-system/blob/java-server/java-server/src/main/java/com/mongodb/devrel/library/domain/provider/EmbeddingProvider.java",children:(0,r.jsx)(n.code,{children:"EmbeddingProvider"})})," interface."]}),(0,r.jsxs)(n.p,{children:["For Google Vertex AI, the implementation is ",(0,r.jsx)(n.a,{href:"https://github.com/mongodb-developer/library-management-system/blob/java-server/java-server/src/main/java/com/mongodb/devrel/library/infrastructure/provider/VertexEmbeddingProvider.java",children:(0,r.jsx)(n.code,{children:"VertexEmbeddingProvider"})}),", which delegates the HTTP call to the Feign client:"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",metastring:"title='src/main/java/com/mongodb/devrel/library/infrastructure/embeddings/vertex/VertexEmbeddingClient.java'",children:'@FeignClient(\n        name = "vertex-embeddings",\n        url = "${vertex.base-url}"\n)\npublic interface VertexEmbeddingClient {\n\n    @PostMapping(\n            value = "/v1/projects/{projectId}/locations/us-central1/publishers/google/models/{model}:predict",\n            consumes = MediaType.APPLICATION_JSON_VALUE)\n    VertexEmbeddingResponse predict(\n            @RequestHeader("Authorization") String bearerToken,\n            @PathVariable("projectId") String projectId,\n            @PathVariable("model") String model,\n            @RequestBody VertexEmbeddingRequest request\n    );\n}\n\n'})}),(0,r.jsx)(n.h2,{id:"configuring-the-application-1",children:"Configuring the application"}),(0,r.jsxs)(n.p,{children:["To use Google Vertex AI, adjust the following parameters in ",(0,r.jsx)(n.code,{children:"application.yml"}),":"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yml",metastring:"title='src/main/resources/application.yml'",children:"embeddings:\n  source: ${EMBEDDING_SOURCE}\nvertex:\n  project-id: ${VERTEX_PROJECT_ID:yourProjectId}\n  api-key: ${VERTEX_KEY:yourKey}\n"})}),(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"embeddings.source"})," property is what selects the provider at runtime. If you set it to googleVertex, the Vertex implementation will be used. You can either edit these values in ",(0,r.jsx)(n.code,{children:"application.yml"}),", or export them as environment variables:"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"export EMBEDDING_SOURCE=googleVertex\nexport VERTEX_PROJECT_ID=<YOUR_PROJECT_ID>\nexport VERTEX_KEY=<YOUR_KEY> \n"})}),(0,r.jsx)(n.h2,{id:"running-the-application",children:"Running the application"}),(0,r.jsx)(n.p,{children:"Once the variables are set, start the application as usual:"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"mvn spring-boot:run\n"})}),(0,r.jsxs)(n.p,{children:["At the end, when the application starts, just make a call to ",(0,r.jsx)(n.code,{children:"searchBooks"})," as\ndescribed in the step ",(0,r.jsx)(n.a,{href:"http://localhost:3000/search-lab/docs/vector-search/add-to-app",children:"Add Semantic Search to Your Application"}),"\nand you will see the application calling the ",(0,r.jsx)(n.strong,{children:"Google Vertex"})," implementation:"]}),(0,r.jsx)(t,{src:"/img/screenshots/7-vector-search/5-create-vectors/4-google-vertex/3-checking-logs.png",url:"https://cloud.google.com"})]})]})]})}function p(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},9365:(e,n,t)=>{t.d(n,{A:()=>i});t(6540);var r=t(8215);const o={tabItem:"tabItem_Ymn6"};var a=t(4848);function i(e){let{children:n,hidden:t,className:i}=e;return(0,a.jsx)("div",{role:"tabpanel",className:(0,r.A)(o.tabItem,i),hidden:t,children:n})}},1470:(e,n,t)=>{t.d(n,{A:()=>w});var r=t(6540),o=t(8215),a=t(3104),i=t(6347),l=t(205),s=t(7485),c=t(1682),d=t(679);function u(e){return r.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:n,children:t}=e;return(0,r.useMemo)((()=>{const e=n??function(e){return u(e).map((e=>{let{props:{value:n,label:t,attributes:r,default:o}}=e;return{value:n,label:t,attributes:r,default:o}}))}(t);return function(e){const n=(0,c.XI)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,t])}function p(e){let{value:n,tabValues:t}=e;return t.some((e=>e.value===n))}function g(e){let{queryString:n=!1,groupId:t}=e;const o=(0,i.W6)(),a=function(e){let{queryString:n=!1,groupId:t}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:n,groupId:t});return[(0,s.aZ)(a),(0,r.useCallback)((e=>{if(!a)return;const n=new URLSearchParams(o.location.search);n.set(a,e),o.replace({...o.location,search:n.toString()})}),[a,o])]}function m(e){const{defaultValue:n,queryString:t=!1,groupId:o}=e,a=h(e),[i,s]=(0,r.useState)((()=>function(e){let{defaultValue:n,tabValues:t}=e;if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!p({value:n,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${t.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const r=t.find((e=>e.default))??t[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:n,tabValues:a}))),[c,u]=g({queryString:t,groupId:o}),[m,v]=function(e){let{groupId:n}=e;const t=function(e){return e?`docusaurus.tab.${e}`:null}(n),[o,a]=(0,d.Dv)(t);return[o,(0,r.useCallback)((e=>{t&&a.set(e)}),[t,a])]}({groupId:o}),b=(()=>{const e=c??m;return p({value:e,tabValues:a})?e:null})();(0,l.A)((()=>{b&&s(b)}),[b]);return{selectedValue:i,selectValue:(0,r.useCallback)((e=>{if(!p({value:e,tabValues:a}))throw new Error(`Can't select invalid tab value=${e}`);s(e),u(e),v(e)}),[u,v,a]),tabValues:a}}var v=t(2303);const b={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var f=t(4848);function x(e){let{className:n,block:t,selectedValue:r,selectValue:i,tabValues:l}=e;const s=[],{blockElementScrollPositionUntilNextRender:c}=(0,a.a_)(),d=e=>{const n=e.currentTarget,t=s.indexOf(n),o=l[t].value;o!==r&&(c(n),i(o))},u=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const t=s.indexOf(e.currentTarget)+1;n=s[t]??s[0];break}case"ArrowLeft":{const t=s.indexOf(e.currentTarget)-1;n=s[t]??s[s.length-1];break}}n?.focus()};return(0,f.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.A)("tabs",{"tabs--block":t},n),children:l.map((e=>{let{value:n,label:t,attributes:a}=e;return(0,f.jsx)("li",{role:"tab",tabIndex:r===n?0:-1,"aria-selected":r===n,ref:e=>s.push(e),onKeyDown:u,onClick:d,...a,className:(0,o.A)("tabs__item",b.tabItem,a?.className,{"tabs__item--active":r===n}),children:t??n},n)}))})}function j(e){let{lazy:n,children:t,selectedValue:a}=e;const i=(Array.isArray(t)?t:[t]).filter(Boolean);if(n){const e=i.find((e=>e.props.value===a));return e?(0,r.cloneElement)(e,{className:(0,o.A)("margin-top--md",e.props.className)}):null}return(0,f.jsx)("div",{className:"margin-top--md",children:i.map(((e,n)=>(0,r.cloneElement)(e,{key:n,hidden:e.props.value!==a})))})}function y(e){const n=m(e);return(0,f.jsxs)("div",{className:(0,o.A)("tabs-container",b.tabList),children:[(0,f.jsx)(x,{...n,...e}),(0,f.jsx)(j,{...n,...e})]})}function w(e){const n=(0,v.A)();return(0,f.jsx)(y,{...e,children:u(e.children)},String(n))}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>l});var r=t(6540);const o={},a=r.createContext(o);function i(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);