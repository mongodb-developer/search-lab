"use strict";(self.webpackChunksearch_party_lab=self.webpackChunksearch_party_lab||[]).push([[5184],{8294:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>p,frontMatter:()=>c,metadata:()=>l,toc:()=>h});var s=r(4848),t=r(8453),o=r(1470),i=r(9365);const c={},a="\ud83e\uddb8\u200d\u2642\ufe0f Implementing Hybrid Search",l={id:"hybrid-search/implementing-hybrid-search",title:"\ud83e\uddb8\u200d\u2642\ufe0f Implementing Hybrid Search",description:"Extra activity, do it if you have extra time or are following at home, won't be covered during the hands-on Lab.",source:"@site/docs/8-hybrid-search/2-implementing-hybrid-search.mdx",sourceDirName:"8-hybrid-search",slug:"/hybrid-search/implementing-hybrid-search",permalink:"/search-lab/docs/hybrid-search/implementing-hybrid-search",draft:!1,unlisted:!1,editUrl:"https://github.com/mongodb-developer/search-lab/blob/main/docs/8-hybrid-search/2-implementing-hybrid-search.mdx",tags:[],version:"current",sidebarPosition:2,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"\ud83d\udcd8 Introduction to Hybrid Search",permalink:"/search-lab/docs/hybrid-search/intro"},next:{title:"\ud83e\uddb8\u200d\u2642\ufe0f Testing the Hybrid Search",permalink:"/search-lab/docs/hybrid-search/testing-hybrid-search"}},d={},h=[{value:"Prerequites",id:"prerequites",level:2},{value:"Function for Full-Text Search",id:"function-for-full-text-search",level:2},{value:"Function for Vector Search",id:"function-for-vector-search",level:2},{value:"Function to compute Weighted Reciprocal Rank Fusion",id:"function-to-compute-weighted-reciprocal-rank-fusion",level:2},{value:"Function to perform Hybrid Search",id:"function-to-perform-hybrid-search",level:2}];function u(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components},{Details:r}=n;return r||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"\ufe0f-implementing-hybrid-search",children:"\ud83e\uddb8\u200d\u2642\ufe0f Implementing Hybrid Search"})}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsx)(n.p,{children:"Extra activity, do it if you have extra time or are following at home, won't be covered during the hands-on Lab."})}),"\n",(0,s.jsxs)(n.p,{children:["In this section, we'll explore how we can implement Hybrid Search using ",(0,s.jsx)(n.a,{href:"https://www.mongodb.com/docs/atlas/atlas-vector-search/tutorials/reciprocal-rank-fusion/#what-is-reciprocal-rank-fusion-",children:"Reciprocal Rank Fusion"}),", a common technique used to combine results from different search methods."]}),"\n",(0,s.jsxs)(n.p,{children:["The MongoDB documentation shows how you can implement the ",(0,s.jsx)(n.a,{href:"https://www.mongodb.com/docs/atlas/atlas-vector-search/tutorials/reciprocal-rank-fusion/#procedure-1",children:"Hybrid Search using a single aggregation pipeline"}),". However, in this lab, we will combine the results from vector search and full-text search with application logic instead."]}),"\n",(0,s.jsx)(n.h2,{id:"prerequites",children:"Prerequites"}),"\n",(0,s.jsx)(n.p,{children:"This segment depends on the setup you have done in previous exercises:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Ensure you have ",(0,s.jsx)(n.a,{href:"https://mongodb-developer.github.io/search-lab/docs/search/search-index",children:"created an Atlas Search index"})," on the ",(0,s.jsx)(n.strong,{children:"books"})," collection with ",(0,s.jsx)(n.strong,{children:"dynamic mappings"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Ensure you have ",(0,s.jsx)(n.a,{href:"https://mongodb-developer.github.io/search-lab/docs/vector-search/import-data",children:"imported the embeddings"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Ensure you have ",(0,s.jsx)(n.a,{href:"https://mongodb-developer.github.io/search-lab/docs/vector-search/create-index",children:"created the vector search index"})," on the ",(0,s.jsx)(n.strong,{children:"embeddings"})," field."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"function-for-full-text-search",children:"Function for Full-Text Search"}),"\n",(0,s.jsxs)(o.A,{groupId:"server",children:[(0,s.jsxs)(i.A,{value:"node",label:"\ud83d\ude80 NodeJS/Express",children:[(0,s.jsxs)(n.p,{children:["Write a new function called ",(0,s.jsx)(n.code,{children:"fullTextSearch"})," in ",(0,s.jsx)(n.code,{children:"books.ts"}),":"]}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["It accepts ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"query"})})," as an argument of ",(0,s.jsx)(n.strong,{children:"string"})," type, and ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"limit"})})," as an argument of ",(0,s.jsx)(n.strong,{children:"number"})," type"]}),"\n",(0,s.jsxs)(n.li,{children:["Using ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"query"})}),", it should perform a full-text search on ",(0,s.jsx)(n.code,{children:"title"}),", ",(0,s.jsx)(n.code,{children:"synopsis"}),", and ",(0,s.jsx)(n.code,{children:"author"})," names, and you may boost scores at your own discretion"]}),"\n",(0,s.jsxs)(n.li,{children:["It should limit the number of books returned using the ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"limit"})})," argument parsed"]}),"\n",(0,s.jsxs)(n.li,{children:["Using ",(0,s.jsx)(n.code,{children:"$project"})," to only return the following book properties: ",(0,s.jsx)(n.code,{children:"_id"}),", ",(0,s.jsx)(n.code,{children:"title"}),", ",(0,s.jsx)(n.code,{children:"authors"}),", ",(0,s.jsx)(n.code,{children:"synopsis"}),", and ",(0,s.jsx)(n.code,{children:"cover"})]}),"\n"]}),(0,s.jsxs)(r,{children:[(0,s.jsx)("summary",{children:"Answer"}),(0,s.jsx)("div",{children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'    public async fullTextSearch(query: string,limit: number): Promise<Book[]>{\n        const pipeline = [\n            {\n              $search: {\n                index: "fulltextsearch",\n                compound: {\n                  should: [\n                    {\n                      text: {\n                        query,\n                        path: "title",\n                        score: { boost: { value: 3 } }\n                      }\n                    },\n                    {\n                        text: {\n                          query,\n                          path: "synopsis",\n                          score: { boost: { value: 2 } }\n                        }\n                    },\n                    {\n                      text: {\n                        query,\n                        path: "authors.name",\n                        score: { boost: { value: 2 } }\n                      }\n                    }\n                  ]\n                }\n              }\n            },{\n              $limit: limit\n            },{\n              $project:{ //project only relevant fields\n                title: 1, authors: 1, synopsis:1, cover:1\n              }\n            }\n          ]\n        const books = await collections?.books?.aggregate(pipeline).toArray() as Book[];\n        return books;\n    }\n\n'})})})]})]}),(0,s.jsxs)(i.A,{value:"java",label:"\u2615\ufe0f Java Spring Boot",children:[(0,s.jsxs)(n.p,{children:["Write a new method called ",(0,s.jsx)(n.code,{children:"fullTextSearch"})," in ",(0,s.jsx)(n.code,{children:"BookService.java"}),":"]}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["It accepts ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"query"})})," as a ",(0,s.jsx)(n.em,{children:"String"})," argument, and ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"limit"})})," as an ",(0,s.jsx)(n.strong,{children:"int"})," argument"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Uing ",(0,s.jsx)(n.strong,{children:"query"}),", it should perform a full-text search on ",(0,s.jsx)(n.code,{children:"title"}),", ",(0,s.jsx)(n.code,{children:"synopsis"}),", and ",(0,s.jsx)(n.code,{children:"author"})," names, applying score boosts where appropriate"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["It should limit the number of books returned using the ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"limit"})})," argument"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Use ",(0,s.jsx)(n.code,{children:"$project"})," to only return the following book properties: ",(0,s.jsx)(n.code,{children:"_id"}),", ",(0,s.jsx)(n.code,{children:"title"}),", ",(0,s.jsx)(n.code,{children:"authors"}),", ",(0,s.jsx)(n.code,{children:"synopsis"}),", and ",(0,s.jsx)(n.code,{children:"cover"}),"\x1b"]}),"\n"]}),"\n"]}),(0,s.jsxs)(r,{children:[(0,s.jsx)("summary",{children:"Answer"}),(0,s.jsx)("div",{children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",metastring:"title='src/main/java/com/mongodb/devrel/library/domain/service/BookService.java'",children:'public List<Book> fullTextSearch(String query, int limit) {\n    AggregationOperation searchStage = context -> new Document("$search",\n        new Document("index", "fulltextsearch")\n            .append("compound",\n                new Document("should", Arrays.asList(\n                    new Document("text",\n                        new Document("query", query)\n                            .append("path", "title")\n                            .append("score", new Document("boost", new Document("value", 3L)))),\n                    new Document("text",\n                        new Document("query", query)\n                            .append("path", "synopsis")\n                            .append("score", new Document("boost", new Document("value", 2L)))),\n                    new Document("text",\n                        new Document("query", query)\n                            .append("path", "authors.name")\n                            .append("score", new Document("boost", new Document("value", 2L))))\n                ))\n            )\n    );\n    AggregationOperation limitStage = context -> new Document("$limit", limit);\n    AggregationOperation projectStage = context -> new Document("$project",\n        new Document("title", 1L)\n            .append("authors", 1L)\n            .append("synopsis", 1L)\n            .append("cover", 1L)\n    );\n    Aggregation aggregation = Aggregation.newAggregation(searchStage, limitStage, projectStage);\n    return mongoTemplate.aggregate(aggregation, "books", Book.class).getMappedResults();\n}\n \n'})})})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"function-for-vector-search",children:"Function for Vector Search"}),"\n",(0,s.jsxs)(o.A,{groupId:"server",children:[(0,s.jsxs)(i.A,{value:"node",label:"\ud83d\ude80 NodeJS/Express",children:[(0,s.jsxs)(n.p,{children:["Write a new function called ",(0,s.jsx)(n.code,{children:"vectorSearch"})," in ",(0,s.jsx)(n.code,{children:"books.ts"}),":"]}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["It accepts ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"query"})})," as an argument of ",(0,s.jsx)(n.strong,{children:"string"})," type, and ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"limit"})})," as an argument of ",(0,s.jsx)(n.strong,{children:"number"})," type"]}),"\n",(0,s.jsxs)(n.li,{children:["It should vectorize the ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"query"})})," and use resulting vector to perform a vector search on ",(0,s.jsx)(n.strong,{children:"books"})," collection."]}),"\n",(0,s.jsxs)(n.li,{children:["It should limit the number of books returned using the ",(0,s.jsx)(n.strong,{children:"limit"})," argument parsed"]}),"\n",(0,s.jsxs)(n.li,{children:["Using ",(0,s.jsx)(n.code,{children:"$project"})," to only return the following book properties: ",(0,s.jsx)(n.code,{children:"_id"}),", ",(0,s.jsx)(n.code,{children:"title"}),", ",(0,s.jsx)(n.code,{children:"authors"}),", ",(0,s.jsx)(n.code,{children:"synopsis"}),", and `cover``\x1b"]}),"\n"]}),(0,s.jsxs)(r,{children:[(0,s.jsx)("summary",{children:"Answer"}),(0,s.jsx)("div",{children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"    public async vectorSearch(query: string, limit: number): Promise<Book[]>{\n        const vector = await getEmbeddings(query);\n        const pipeline = [\n            {\n                $vectorSearch: {\n                  queryVector:  vector,\n                  path: 'embeddings',\n                  numCandidates: 100,\n                  index: 'vectorsearch',\n                  limit: limit,\n                }\n            },{\n                $project:{ //project only relevant fields\n                  title: 1, authors: 1, synopsis:1, cover:1\n                }\n            }\n          ]\n        const books = await collections?.books?.aggregate(pipeline).toArray() as Book[];\n        return books;\n    }\n\n"})})})]})]}),(0,s.jsxs)(i.A,{value:"java",label:"\u2615\ufe0f Java Spring Boot",children:[(0,s.jsxs)(n.p,{children:["Write a new method called ",(0,s.jsx)(n.code,{children:"vectorSearch"})," in ",(0,s.jsx)(n.code,{children:"BookService.java"}),":"]}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["It accepts ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"query"})})," as a ",(0,s.jsx)(n.strong,{children:"String"})," argument, and ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"limit"})})," as an ",(0,s.jsx)(n.strong,{children:"int"})," argument"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["It should vectorize ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"query"})})," using the configured ",(0,s.jsx)(n.code,{children:"EmbeddingProvider"}),"\nand use the resulting vector to perform a ",(0,s.jsx)(n.code,{children:"$vectorSearch"})," on the books collection"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["It should limit the number of books returned using the ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"limit"})})," argument"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Use ",(0,s.jsx)(n.code,{children:"$project"})," to only return the following book properties: ",(0,s.jsx)(n.code,{children:"_id"}),", ",(0,s.jsx)(n.code,{children:"title"}),", ",(0,s.jsx)(n.code,{children:"authors"}),", ",(0,s.jsx)(n.code,{children:"synopsis"}),", and ",(0,s.jsx)(n.code,{children:"cover"})]}),"\n"]}),"\n"]}),(0,s.jsxs)(r,{children:[(0,s.jsx)("summary",{children:"Answer"}),(0,s.jsx)("div",{children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",metastring:"title='src/main/java/com/mongodb/devrel/library/domain/service/BookService.java'",children:'public List<Book> vectorSearch(String query, int limit) {\n    List<Double> vector = embeddingProvider.getEmbeddings(query);\n\n    AggregationOperation searchStage = context ->\n            new Document("$vectorSearch",\n                    new Document("index", "vectorsearch")\n                            .append("path", "embeddings")\n                            .append("queryVector", vector)\n                            .append("numCandidates", 100)\n                            .append("limit", limit)\n            );\n\n    AggregationOperation projectStage = context ->\n            new Document("$project",\n                    new Document("title", 1L)\n                            .append("authors", 1L)\n                            .append("synopsis", 1L)\n                            .append("cover", 1L)\n            );\n\n    Aggregation aggregation = Aggregation.newAggregation(searchStage, projectStage);\n\n    return mongoTemplate.aggregate(aggregation, "books", Book.class).getMappedResults();\n}\n'})})})]})]})]}),"\n",(0,s.jsxs)(n.h2,{id:"function-to-compute-weighted-reciprocal-rank-fusion",children:["Function to compute Weighted ",(0,s.jsx)(n.a,{href:"https://www.mongodb.com/docs/atlas/atlas-vector-search/tutorials/reciprocal-rank-fusion/#what-is-reciprocal-rank-fusion-",children:"Reciprocal Rank Fusion"})]}),"\n",(0,s.jsx)(n.p,{children:"Atlas full-text search and vector search, by default, returns documents sorted by their relevancy score from highest to lowest i.e. they are ranked by default."}),"\n",(0,s.jsxs)(n.p,{children:["A reciprocal rank score is given by ",(0,s.jsx)(n.code,{children:"1 / (RANK * RANK_CONSTANT)"}),". A ",(0,s.jsx)(n.strong,{children:"RANK_CONSTANT"})," (typically about 60), prevents the case of ",(0,s.jsx)(n.code,{children:"1/0"})," where ",(0,s.jsx)(n.strong,{children:"RANK"})," is 0, and smoothens the scores so that it is not too heavily skewed towards higher ranked documents."]}),"\n",(0,s.jsx)(n.p,{children:"You may give different weightage to full-text search versus vector search by multiplying the scores with a different weight."}),"\n",(0,s.jsxs)(o.A,{groupId:"server",children:[(0,s.jsxs)(i.A,{value:"node",label:"\ud83d\ude80 NodeJS/Express",children:[(0,s.jsxs)(n.p,{children:["Write a new private function called ",(0,s.jsx)(n.code,{children:"computeWeightedRRF"})," in ",(0,s.jsx)(n.code,{children:"books.ts"}),":"]}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["It accepts ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"books"})})," as an argument of ",(0,s.jsx)(n.strong,{children:"Book[]"})," type, and ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"weight"})})," as an argument of ",(0,s.jsx)(n.strong,{children:"number"})," type"]}),"\n",(0,s.jsx)(n.li,{children:"It should compute the Reciprocal Rank score based on its position in the array (the first book in the array should be ranked 0)."}),"\n",(0,s.jsxs)(n.li,{children:["Mulitply the score further by the given ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"weight"})})," and store the resultant score as ",(0,s.jsx)(n.code,{children:"score"})," back into the book object."]}),"\n"]}),(0,s.jsxs)(r,{children:[(0,s.jsx)("summary",{children:"Answer"}),(0,s.jsx)("div",{children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"    private computeWeightedRRF(books: Book[], weight: number): void{\n        const RANK_CONSTANT = 60;\n        books.forEach((book,i)=>{\n            book['score'] = weight*1/(i+RANK_CONSTANT)\n            return book;\n        })\n    }\n"})})})]})]}),(0,s.jsxs)(i.A,{value:"java",label:"\u2615\ufe0f Java Spring Boot",children:[(0,s.jsx)(n.p,{children:"In Java, the Book entity is defined as an immutable record mapped to the database.\nBecause of this, we cannot simply add or modify a field such as score at runtime.\nTo handle the computation of scores for Hybrid Search, we need two things:"}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["A new wrapper type to hold both the ",(0,s.jsx)(n.code,{children:"Book"})," and its computed score."]}),"\n",(0,s.jsx)(n.li,{children:"A helper method that calculates the Reciprocal Rank score and returns this wrapper."}),"\n"]}),(0,s.jsxs)(n.p,{children:["First, create a new ",(0,s.jsx)(n.code,{children:"BookWithScore"})," record:"]}),(0,s.jsxs)(r,{children:[(0,s.jsx)("summary",{children:"Answer"}),(0,s.jsx)("div",{children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",metastring:"title='src/main/java/com/mongodb/devrel/library/domain/model/BookWithScore.java'",children:"public record BookWithScore(Book book, double score) {}\n"})})})]}),(0,s.jsxs)(n.p,{children:["Then, add a private method ",(0,s.jsx)(n.code,{children:"computeWeightedRRF"})," in ",(0,s.jsx)(n.code,{children:"BookService.java"}),":"]}),(0,s.jsxs)(r,{children:[(0,s.jsx)("summary",{children:"Answer"}),(0,s.jsx)("div",{children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",metastring:"title='src/main/java/com/mongodb/devrel/library/domain/service/BookService.java'",children:"private List<BookWithScore> computeWeightedRRF(List<Book> books, double weight) {\n    final int RANK_CONSTANT = 60;\n    List<BookWithScore> scoredBooks = new ArrayList<>();\n\n    for (int i = 0; i < books.size(); i++) {\n        Book book = books.get(i);\n        double score = weight * (1.0 / (i + RANK_CONSTANT));\n        scoredBooks.add(new BookWithScore(book, score));\n    }\n\n    return scoredBooks;\n}\n"})})})]}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["It accepts books as a ",(0,s.jsx)(n.code,{children:"List<Book>"})," argument, and weight as a double argument"]}),"\n",(0,s.jsx)(n.li,{children:"It computes the Reciprocal Rank score based on each book\u2019s position in the list (the first book has rank 0)"}),"\n",(0,s.jsxs)(n.li,{children:["It multiplies the ",(0,s.jsx)(n.code,{children:"score"})," by the given weight"]}),"\n",(0,s.jsxs)(n.li,{children:["It returns a list of ",(0,s.jsx)(n.code,{children:"BookWithScore"})," objects"]}),"\n"]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"function-to-perform-hybrid-search",children:"Function to perform Hybrid Search"}),"\n",(0,s.jsx)(n.p,{children:"The final thing we need to do is to combine the scores by summing the scores from both types of searches.\nIf the same book is found in two searches, the score should be summed up giving it a higher score."}),"\n",(0,s.jsxs)(o.A,{groupId:"server",children:[(0,s.jsxs)(i.A,{value:"node",label:"\ud83d\ude80 NodeJS/Express",children:[(0,s.jsxs)(n.p,{children:["Replace the ",(0,s.jsx)(n.code,{children:"searchBooks"})," function in ",(0,s.jsx)(n.code,{children:"books.ts"}),":"]}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["It accepts ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"query"})})," as an argument of ",(0,s.jsx)(n.strong,{children:"string"})," type"]}),"\n",(0,s.jsxs)(n.li,{children:["It should execute both full-text search and vector search based on the ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"query"})})]}),"\n",(0,s.jsxs)(n.li,{children:["It should parse both results into the ",(0,s.jsx)(n.code,{children:"computeWeightedRRF"}),". Lets give full-text search a weight of ",(0,s.jsx)(n.strong,{children:"0.5"})," and vector search a weight of ",(0,s.jsx)(n.strong,{children:"0.5"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Sum the two scores from both sets of results, re-rank the books based on the new scores and return the ",(0,s.jsx)(n.strong,{children:"top 5"})," books"]}),"\n"]}),(0,s.jsxs)(r,{children:[(0,s.jsx)("summary",{children:"Answer"}),(0,s.jsx)("div",{children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"    public async searchBooks(query: string): Promise<Book[]> {\n        const VECTOR_WEIGHT = 0.6;\n        const FULL_TEXT_WEIGHT = 0.4;\n        const SEARCH_LIMIT = 6\n\n        //run full text search and vector search separately\n        const [fts_results,vs_results] = await Promise.all([\n            this.fullTextSearch(query, SEARCH_LIMIT),\n            this.vectorSearch(query, SEARCH_LIMIT)\n        ])\n\n        //compute weighted Reciprocal Rank Fusion on both results\n        this.computeWeightedRRF(fts_results, FULL_TEXT_WEIGHT)\n        this.computeWeightedRRF(vs_results, VECTOR_WEIGHT)\n\n        //aggregate both arrays to a single map using _id as a key\n        const documentMap = [...fts_results,...vs_results].reduce((map,book:any)=>{\n            if(map.hasOwnProperty(book._id)){\n                map[book._id].score += book.score;\n            }else{\n                map[book._id] = book;\n            }\n            return map;\n        },{})\n\n        //transform map back to an array\n        const books = Object.keys(documentMap).map(k=>documentMap[k]);\n\n        //return books with the highest scores\n        const topBooks = books.sort((a,b)=>b.score-a.score).slice(0,SEARCH_LIMIT);\n        return topBooks;\n      }\n"})})})]})]}),(0,s.jsxs)(i.A,{value:"java",label:"\u2615\ufe0f Java Spring Boot",children:[(0,s.jsx)(n.p,{children:"Replace the searchBook methods in BookService.java:"}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["It accepts ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"theTerm"})})," as a ",(0,s.jsx)(n.strong,{children:"String"})," argument"]}),"\n",(0,s.jsxs)(n.li,{children:["It should execute both full-text search and vector search using the given ",(0,s.jsx)(n.em,{children:(0,s.jsx)(n.strong,{children:"query"})})]}),"\n",(0,s.jsxs)(n.li,{children:["It should pass both result sets into ",(0,s.jsx)(n.code,{children:"computeWeightedRRF"}),". Let\u2019s give full-text search a weight of 0.4 and vector search a weight of 0.6"]}),"\n",(0,s.jsxs)(n.li,{children:["It should combine the results into a map keyed by book ",(0,s.jsx)(n.code,{children:"_id"}),", summing the scores if the same book appears in both searches"]}),"\n",(0,s.jsx)(n.li,{children:"It should return the top 5\u20136 books sorted by score in descending order"}),"\n"]}),(0,s.jsxs)(r,{children:[(0,s.jsx)("summary",{children:"Answer"}),(0,s.jsx)("div",{children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",metastring:"title='src/main/java/com/mongodb/devrel/library/domain/service/BookService.java'",children:"public List<Book> searchBooks(String theTerm) {\n    final double VECTOR_WEIGHT = 0.6;\n    final double FULL_TEXT_WEIGHT = 0.4;\n    final int SEARCH_LIMIT = 6;\n\n    List<Book> ftsResults = fullTextSearch(theTerm, SEARCH_LIMIT);\n    List<Book> vsResults = vectorSearch(theTerm, SEARCH_LIMIT);\n\n    List<BookWithScore> scoredFts = computeWeightedRRF(ftsResults, FULL_TEXT_WEIGHT);\n    List<BookWithScore> scoredVs = computeWeightedRRF(vsResults, VECTOR_WEIGHT);\n\n    Map<String, Double> scoreMap = new HashMap<>();\n    Map<String, Book> bookMap = new HashMap<>();\n\n    Stream.concat(scoredFts.stream(), scoredVs.stream())\n            .forEach(bws -> {\n                String id = bws.book().id();\n                bookMap.putIfAbsent(id, bws.book());\n                scoreMap.merge(id, bws.score(), Double::sum);\n            });\n\n    return scoreMap.entrySet().stream()\n            .sorted(Map.Entry.<String, Double>comparingByValue().reversed())\n            .limit(SEARCH_LIMIT)\n            .map(entry -> bookMap.get(entry.getKey()))\n            .toList();\n}\n"})})})]})]})]})]})}function p(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},9365:(e,n,r)=>{r.d(n,{A:()=>i});r(6540);var s=r(8215);const t={tabItem:"tabItem_Ymn6"};var o=r(4848);function i(e){let{children:n,hidden:r,className:i}=e;return(0,o.jsx)("div",{role:"tabpanel",className:(0,s.A)(t.tabItem,i),hidden:r,children:n})}},1470:(e,n,r)=>{r.d(n,{A:()=>k});var s=r(6540),t=r(8215),o=r(3104),i=r(6347),c=r(205),a=r(7485),l=r(1682),d=r(679);function h(e){return s.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,s.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function u(e){const{values:n,children:r}=e;return(0,s.useMemo)((()=>{const e=n??function(e){return h(e).map((e=>{let{props:{value:n,label:r,attributes:s,default:t}}=e;return{value:n,label:r,attributes:s,default:t}}))}(r);return function(e){const n=(0,l.XI)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,r])}function p(e){let{value:n,tabValues:r}=e;return r.some((e=>e.value===n))}function m(e){let{queryString:n=!1,groupId:r}=e;const t=(0,i.W6)(),o=function(e){let{queryString:n=!1,groupId:r}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!r)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return r??null}({queryString:n,groupId:r});return[(0,a.aZ)(o),(0,s.useCallback)((e=>{if(!o)return;const n=new URLSearchParams(t.location.search);n.set(o,e),t.replace({...t.location,search:n.toString()})}),[o,t])]}function x(e){const{defaultValue:n,queryString:r=!1,groupId:t}=e,o=u(e),[i,a]=(0,s.useState)((()=>function(e){let{defaultValue:n,tabValues:r}=e;if(0===r.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!p({value:n,tabValues:r}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${r.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const s=r.find((e=>e.default))??r[0];if(!s)throw new Error("Unexpected error: 0 tabValues");return s.value}({defaultValue:n,tabValues:o}))),[l,h]=m({queryString:r,groupId:t}),[x,g]=function(e){let{groupId:n}=e;const r=function(e){return e?`docusaurus.tab.${e}`:null}(n),[t,o]=(0,d.Dv)(r);return[t,(0,s.useCallback)((e=>{r&&o.set(e)}),[r,o])]}({groupId:t}),j=(()=>{const e=l??x;return p({value:e,tabValues:o})?e:null})();(0,c.A)((()=>{j&&a(j)}),[j]);return{selectedValue:i,selectValue:(0,s.useCallback)((e=>{if(!p({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);a(e),h(e),g(e)}),[h,g,o]),tabValues:o}}var g=r(2303);const j={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var b=r(4848);function v(e){let{className:n,block:r,selectedValue:s,selectValue:i,tabValues:c}=e;const a=[],{blockElementScrollPositionUntilNextRender:l}=(0,o.a_)(),d=e=>{const n=e.currentTarget,r=a.indexOf(n),t=c[r].value;t!==s&&(l(n),i(t))},h=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const r=a.indexOf(e.currentTarget)+1;n=a[r]??a[0];break}case"ArrowLeft":{const r=a.indexOf(e.currentTarget)-1;n=a[r]??a[a.length-1];break}}n?.focus()};return(0,b.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,t.A)("tabs",{"tabs--block":r},n),children:c.map((e=>{let{value:n,label:r,attributes:o}=e;return(0,b.jsx)("li",{role:"tab",tabIndex:s===n?0:-1,"aria-selected":s===n,ref:e=>a.push(e),onKeyDown:h,onClick:d,...o,className:(0,t.A)("tabs__item",j.tabItem,o?.className,{"tabs__item--active":s===n}),children:r??n},n)}))})}function f(e){let{lazy:n,children:r,selectedValue:o}=e;const i=(Array.isArray(r)?r:[r]).filter(Boolean);if(n){const e=i.find((e=>e.props.value===o));return e?(0,s.cloneElement)(e,{className:(0,t.A)("margin-top--md",e.props.className)}):null}return(0,b.jsx)("div",{className:"margin-top--md",children:i.map(((e,n)=>(0,s.cloneElement)(e,{key:n,hidden:e.props.value!==o})))})}function y(e){const n=x(e);return(0,b.jsxs)("div",{className:(0,t.A)("tabs-container",j.tabList),children:[(0,b.jsx)(v,{...n,...e}),(0,b.jsx)(f,{...n,...e})]})}function k(e){const n=(0,g.A)();return(0,b.jsx)(y,{...e,children:h(e.children)},String(n))}},8453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>c});var s=r(6540);const t={},o=s.createContext(t);function i(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);