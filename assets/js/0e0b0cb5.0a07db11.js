"use strict";(self.webpackChunksearch_party_lab=self.webpackChunksearch_party_lab||[]).push([[428],{3679:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>u,contentTitle:()=>l,default:()=>p,frontMatter:()=>i,metadata:()=>c,toc:()=>d});var a=r(4848),n=r(8453),o=r(1470),s=r(9365);const i={},l="\ud83d\udc50 Add Full-text Search to Your Application",c={id:"add-to-app/add-to-app",title:"\ud83d\udc50 Add Full-text Search to Your Application",description:"So far, you've seen how to use the search indexes in the aggregation pipeline builder or Compass. But what if you want to use the search index in your application?",source:"@site/docs/4-add-to-app/1-add-to-app.mdx",sourceDirName:"4-add-to-app",slug:"/add-to-app/add-to-app",permalink:"/search-lab/docs/add-to-app/add-to-app",draft:!1,unlisted:!1,editUrl:"https://github.com/mongodb-developer/search-lab/blob/main/docs/4-add-to-app/1-add-to-app.mdx",tags:[],version:"current",sidebarPosition:1,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Implementing Atlas Search",permalink:"/search-lab/docs/category/implementing-atlas-search"},next:{title:"Search Operators",permalink:"/search-lab/docs/category/search-operators"}},u={},d=[{value:"Adding search to the library app",id:"adding-search-to-the-library-app",level:2},{value:"Adding search to the library app",id:"adding-search-to-the-library-app-1",level:2}];function h(e){const t={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,n.R)(),...e.components},{Details:r}=t;return r||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.header,{children:(0,a.jsx)(t.h1,{id:"-add-full-text-search-to-your-application",children:"\ud83d\udc50 Add Full-text Search to Your Application"})}),"\n",(0,a.jsx)(t.p,{children:"So far, you've seen how to use the search indexes in the aggregation pipeline builder or Compass. But what if you want to use the search index in your application?"}),"\n",(0,a.jsx)(t.p,{children:"To do so, you will need to add some code to your application."}),"\n",(0,a.jsxs)(o.A,{groupId:"server",children:[(0,a.jsxs)(s.A,{value:"node",label:"\ud83d\ude80 NodeJS/Express",children:[(0,a.jsxs)(t.p,{children:["To use the aggregation pipeline in Node.js, you will need to use the ",(0,a.jsx)(t.code,{children:"aggregate"})," method on the collection object. This method takes an array of stages as an argument and returns a cursor. You can then use the cursor to iterate over the results or use the ",(0,a.jsx)(t.code,{children:"toArray"})," method to get the results in an array."]}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-js",children:"const documents = await collection.aggregate(aggregationPipelines).toArray();\n"})}),(0,a.jsx)(t.p,{children:"You now know everything you need to add full-text search capabilities to your application."}),(0,a.jsx)(t.h2,{id:"adding-search-to-the-library-app",children:"Adding search to the library app"}),(0,a.jsxs)(t.p,{children:["Open up the code from the server file ",(0,a.jsx)(t.code,{children:"server/src/controllers/books.ts"}),". In there, look for the ",(0,a.jsx)(t.code,{children:"searchBooks"})," function."]}),(0,a.jsx)(t.p,{children:"Right now, it uses a regular expression to query the database."}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-js",metastring:"title='server/src/controllers/books.ts'",children:'public async searchBooks(query: string): Promise<Book[]> {\n  const books = await collections?.books?.find({ title: {$regex: new RegExp(query, "i")} }).toArray();\n  return books;\n}\n'})}),(0,a.jsx)(t.p,{children:"While this code works to a certain extent, it is less than optimal. As the dataset grows, the performance of this query will degrade because it will have to scan the entire collection. You cannot query the index with a regular expression. Furthermore, the query only matches on the title and only for the exact sequence of characters."}),(0,a.jsxs)(t.p,{children:["Change this code to use the search index instead. You will need to use the ",(0,a.jsx)(t.code,{children:"$search"})," stage in the aggregation pipeline. Have your search cover the title, the author name, and the genres array."]}),(0,a.jsxs)(t.p,{children:["This code will go in the ",(0,a.jsx)(t.code,{children:"server/src/controllers/books.ts"})," file, in the ",(0,a.jsx)(t.code,{children:"searchBooks"})," function."]}),(0,a.jsxs)(r,{children:[(0,a.jsx)("summary",{children:"Click here to see the answer"}),(0,a.jsx)("div",{children:(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-js",metastring:"title='server/src/controllers/books.ts'",children:"public async searchBooks(query: string): Promise<Book[]> {\n  const aggregationPipeline = [\n      {\n          $search: {\n              index: 'fulltextsearch',\n              text: {\n                  query,\n                  path: ['title', 'authors.name', 'genres']\n              }\n          }\n      }\n  ];\n  const books = await collections?.books?.aggregate(aggregationPipeline).toArray() as Book[];\n  return books;\n}\n"})})})]})]}),(0,a.jsxs)(s.A,{value:"java",label:"\u2615\ufe0f Java Spring Boot",children:[(0,a.jsxs)(t.p,{children:["To use the aggregation pipeline in Java, you can build your search stage using the ",(0,a.jsx)(t.code,{children:"$search"})," operator and then create an Aggregation. Finally, run the aggregation with MongoTemplate.aggregate, mapping the results directly to your domain class."]}),(0,a.jsx)(t.h2,{id:"adding-search-to-the-library-app-1",children:"Adding search to the library app"}),(0,a.jsxs)(t.p,{children:["Open the ",(0,a.jsx)(t.code,{children:"BookService"})," class in your Java project and look for the ",(0,a.jsx)(t.code,{children:"searchBooks"})," method."]}),(0,a.jsx)(t.p,{children:"Right now, it uses a repository method with a simple text search:"}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",metastring:"title='java-server/src/main/java/com/mongodb/devrel/library/domain/service/BookService.java'",children:"public List<Book> searchBooks(String theTerm) {\n    PageRequest request = PageRequest.of(0, 10, Sort.unsorted());\n    return bookRepository.searchByText(theTerm, request);\n}\n"})}),(0,a.jsxs)(t.p,{children:["While this code works to some extent, it is not optimal. As the dataset grows, performance will degrade because the search is not using the dedicated Atlas Search index. It also limits the query to very basic text matching. Change this method to use the ",(0,a.jsx)(t.strong,{children:"$search"})," stage in the aggregation pipeline instead.\nYour search should cover:"]}),(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsxs)(t.li,{children:["the ",(0,a.jsx)(t.code,{children:"title"})]}),"\n",(0,a.jsxs)(t.li,{children:["the ",(0,a.jsx)(t.code,{children:"authors.name"})]}),"\n",(0,a.jsxs)(t.li,{children:["the ",(0,a.jsx)(t.code,{children:"genres"})," array"]}),"\n"]}),(0,a.jsxs)(t.p,{children:["Use the aggregation code you saw earlier to build the ",(0,a.jsx)(t.code,{children:"$search"})," stage and run it with ",(0,a.jsx)(t.code,{children:"MongoTemplate.aggregate"}),"."]}),(0,a.jsxs)(r,{children:[(0,a.jsx)("summary",{children:"Click here to see the answer"}),(0,a.jsx)("div",{children:(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",metastring:"title='src/main/java/com/mongodb/devrel/library/domain/service/BookService.java'",children:'public List<Book> searchBooks(String theTerm) {\n    AggregationOperation searchStage = context -> new Document("$search",\n      new Document("index", "fulltextsearch")\n              .append("text", new Document("query", theTerm)\n              .append("path", Arrays.asList("title", "authors.name", "genres")))\n    );\n    Aggregation aggregation = Aggregation.newAggregation(searchStage);\n\n    return mongoTemplate.aggregate(aggregation, "books", Book.class).getMappedResults();\n}\n'})})})]})]})]})]})}function p(e={}){const{wrapper:t}={...(0,n.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},9365:(e,t,r)=>{r.d(t,{A:()=>s});r(6540);var a=r(8215);const n={tabItem:"tabItem_Ymn6"};var o=r(4848);function s(e){let{children:t,hidden:r,className:s}=e;return(0,o.jsx)("div",{role:"tabpanel",className:(0,a.A)(n.tabItem,s),hidden:r,children:t})}},1470:(e,t,r)=>{r.d(t,{A:()=>w});var a=r(6540),n=r(8215),o=r(3104),s=r(6347),i=r(205),l=r(7485),c=r(1682),u=r(679);function d(e){return a.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,a.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:t,children:r}=e;return(0,a.useMemo)((()=>{const e=t??function(e){return d(e).map((e=>{let{props:{value:t,label:r,attributes:a,default:n}}=e;return{value:t,label:r,attributes:a,default:n}}))}(r);return function(e){const t=(0,c.XI)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,r])}function p(e){let{value:t,tabValues:r}=e;return r.some((e=>e.value===t))}function g(e){let{queryString:t=!1,groupId:r}=e;const n=(0,s.W6)(),o=function(e){let{queryString:t=!1,groupId:r}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!r)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return r??null}({queryString:t,groupId:r});return[(0,l.aZ)(o),(0,a.useCallback)((e=>{if(!o)return;const t=new URLSearchParams(n.location.search);t.set(o,e),n.replace({...n.location,search:t.toString()})}),[o,n])]}function m(e){const{defaultValue:t,queryString:r=!1,groupId:n}=e,o=h(e),[s,l]=(0,a.useState)((()=>function(e){let{defaultValue:t,tabValues:r}=e;if(0===r.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!p({value:t,tabValues:r}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${r.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const a=r.find((e=>e.default))??r[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:t,tabValues:o}))),[c,d]=g({queryString:r,groupId:n}),[m,b]=function(e){let{groupId:t}=e;const r=function(e){return e?`docusaurus.tab.${e}`:null}(t),[n,o]=(0,u.Dv)(r);return[n,(0,a.useCallback)((e=>{r&&o.set(e)}),[r,o])]}({groupId:n}),x=(()=>{const e=c??m;return p({value:e,tabValues:o})?e:null})();(0,i.A)((()=>{x&&l(x)}),[x]);return{selectedValue:s,selectValue:(0,a.useCallback)((e=>{if(!p({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);l(e),d(e),b(e)}),[d,b,o]),tabValues:o}}var b=r(2303);const x={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var f=r(4848);function v(e){let{className:t,block:r,selectedValue:a,selectValue:s,tabValues:i}=e;const l=[],{blockElementScrollPositionUntilNextRender:c}=(0,o.a_)(),u=e=>{const t=e.currentTarget,r=l.indexOf(t),n=i[r].value;n!==a&&(c(t),s(n))},d=e=>{let t=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":{const r=l.indexOf(e.currentTarget)+1;t=l[r]??l[0];break}case"ArrowLeft":{const r=l.indexOf(e.currentTarget)-1;t=l[r]??l[l.length-1];break}}t?.focus()};return(0,f.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,n.A)("tabs",{"tabs--block":r},t),children:i.map((e=>{let{value:t,label:r,attributes:o}=e;return(0,f.jsx)("li",{role:"tab",tabIndex:a===t?0:-1,"aria-selected":a===t,ref:e=>l.push(e),onKeyDown:d,onClick:u,...o,className:(0,n.A)("tabs__item",x.tabItem,o?.className,{"tabs__item--active":a===t}),children:r??t},t)}))})}function y(e){let{lazy:t,children:r,selectedValue:o}=e;const s=(Array.isArray(r)?r:[r]).filter(Boolean);if(t){const e=s.find((e=>e.props.value===o));return e?(0,a.cloneElement)(e,{className:(0,n.A)("margin-top--md",e.props.className)}):null}return(0,f.jsx)("div",{className:"margin-top--md",children:s.map(((e,t)=>(0,a.cloneElement)(e,{key:t,hidden:e.props.value!==o})))})}function j(e){const t=m(e);return(0,f.jsxs)("div",{className:(0,n.A)("tabs-container",x.tabList),children:[(0,f.jsx)(v,{...t,...e}),(0,f.jsx)(y,{...t,...e})]})}function w(e){const t=(0,b.A)();return(0,f.jsx)(j,{...e,children:d(e.children)},String(t))}},8453:(e,t,r)=>{r.d(t,{R:()=>s,x:()=>i});var a=r(6540);const n={},o=a.createContext(n);function s(e){const t=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:s(e.components),a.createElement(o.Provider,{value:t},e.children)}}}]);